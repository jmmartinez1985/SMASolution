<script src="~/Scripts/jquery.filedrop.js"></script>
<link href="~/Content/FileUpload/jquery.fileupload-ui.css" rel="stylesheet" />
<script src="~/Scripts/jquery-ui-1.8.24.min.js"></script>
@*<link href="~/Content/FileUpload/jquery.fileupload-ui.css" rel="stylesheet" />
<script src="~/Scripts/jquery-1.8.2.min.js"></script>
<script src="~/Scripts/jquery-ui-1.8.24.min.js"></script>
<script src="~/Scripts/FileUpload/canvas-to-blob.min.js"></script>
<script src="~/Scripts/FileUpload/tmpl.min.js"></script>
<script src="~/Scripts/FileUpload/canvas-to-blob.min.js"></script>
<script src="~/Scripts/FileUpload/load-image.min.js"></script>

<script src="~/Scripts/Bootstrap2.3/bootstrap.min.js"></script>
<script src="~/Scripts/FileUpload/jquery.iframe-transport.js"></script>
<script src="~/Scripts/FileUpload/jquery.fileupload.js"></script>
<script src="~/Scripts/FileUpload/jquery.fileupload-ip.js"></script>
<script src="~/Scripts/FileUpload/jquery.fileupload-ui.js"></script>
<script src="~/Scripts/FileUpload/locale.js"></script>
<script src="~/Scripts/FileUpload/main.js"></script>


<br />

<div class="headline">
    <h3>Contenido Multimedia</h3>
</div>

<div class="row-fluid">
    <div class="span12">

        <form id="fileupload" action="~/HttpHandler/UploadHandler.ashx" method="POST" enctype="multipart/form-data">
            <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
            <div class="row fileupload-buttonbar">
                <div class="span9">
                    <!-- The fileinput-button span is used to style the file input field as button -->
                    <span class="btn btn-success fileinput-button" style="margin-top: 5px;">
                        <i class="icon-plus icon-white"></i>
                        <span>Subir imagenes...</span>
                        <input type="file" name="files[]" multiple>
                    </span>
                    <button type="submit" class="btn-u start">
                        <i class="icon-upload icon-white"></i>
                        <span>Iniciar carga</span>
                    </button>
                    <button type="reset" class="btn-u cancel">
                        <i class="icon-ban-circle icon-white"></i>
                        <span>Cancelar carga</span>
                    </button>
                    <button type="button" class="btn btn-danger delete" style="margin-top: 5px;">
                        <i class="icon-trash icon-white"></i>
                        <span>Borrar</span>
                    </button>
                    <input type="checkbox" class="toggle">
                </div>
                <div class="span5">
                    <!-- The global progress bar -->
                    <div class="progress progress-success progress-striped active fade">
                        <div class="bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            <!-- The loading indicator is shown during image processing -->
            <div class="fileupload-loading"></div>
            <br>
            <!-- The table listing the files available for upload/download -->
            <table class="table table-striped">
                <tbody class="files" data-toggle="modal-gallery" data-target="#modal-gallery"></tbody>
            </table>
        </form>

        <!-- modal-gallery is the modal dialog used for the image gallery -->
        <div id="modal-gallery" class="modal modal-gallery hide fade">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">&times;</a>
                <h3 class="modal-title"></h3>
            </div>
            <div class="modal-body">
                <div class="modal-image"></div>
            </div>
            <div class="modal-footer">
                <a class="btn-u modal-next">
                    <span>Next</span>
                    <i class="icon-arrow-right icon-white"></i>
                </a>
                <a class="btn btn-info modal-prev">
                    <i class="icon-arrow-left icon-white"></i>
                    <span>Previous</span>
                </a>
                <a class="btn btn-success modal-play modal-slideshow" data-slideshow="5000">
                    <i class="icon-play icon-white"></i>
                    <span>Slideshow</span>
                </a>
                <a class="btn modal-download" target="_blank">
                    <i class="icon-download"></i>
                    <span>Download</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- The template to display files available for upload -->
<script id="template-upload" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-upload fade">
        <td class="preview"><span class="fade"></span></td>
        <td class="name"><span>{%=file.name%}</span></td>
        <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
        {% if (file.error) { %}
            <td class="error" colspan="2"><span class="label label-important">{%=locale.fileupload.error%}</span> {%=locale.fileupload.errors[file.error] || file.error%}</td>
        {% } else if (o.files.valid && !i) { %}
            <td>
                <div class="progress progress-success progress-striped active"><div class="bar" style="width:0%;"></div></div>
            </td>
            <td class="start">{% if (!o.options.autoUpload) { %}
                <button class="btn-u">
                    <i class="icon-upload icon-white"></i>
                    <span>{%=locale.fileupload.start%}</span>
                </button>
            {% } %}</td>
        {% } else { %}
            <td colspan="2"></td>
        {% } %}
        <td class="cancel">{% if (!i) { %}
            <button class="btn btn-warning">
                <i class="icon-ban-circle icon-white"></i>
                <span>{%=locale.fileupload.cancel%}</span>
            </button>
        {% } %}</td>
    </tr>
{% } %}
</script>
<!-- The template to display files available for download -->
<script id="template-download" type="text/x-tmpl">
{% for (var i=0, file; file=o.files[i]; i++) { %}
    <tr class="template-download fade">
        {% if (file.error) { %}
            <td></td>
            <td class="name"><span>{%=file.name%}</span></td>
            <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
            <td class="error" colspan="2"><span class="label label-important">{%=locale.fileupload.error%}</span> {%=locale.fileupload.errors[file.error] || file.error%}</td>
        {% } else { %}
            <td class="preview">{% if (file.thumbnail_url) { %}
                <a href="{%=file.url%}" title="{%=file.name%}" class="thumbnail" rel="gallery" download="{%=file.name%}"><img src="{%=file.thumbnail_url%}" style="width: 120px; height: 80px;"></a>
            {% } %}</td>
            <td class="name">
                <a href="{%=file.url%}" title="{%=file.name%}" rel="{%=file.thumbnail_url&&'gallery'%}" download="{%=file.name%}">{%=file.name%}</a>
            </td>
            <td class="size"><span>{%=o.formatFileSize(file.size)%}</span></td>
            <td colspan="2"></td>
        {% } %}
        <td class="delete">
            <button class="btn btn-danger" data-type="{%=file.delete_type%}" data-url="{%=file.delete_url%}">
                <i class="icon-trash icon-white"></i>
                <span>{%=locale.fileupload.destroy%}</span>
            </button>
            <input type="checkbox" name="delete" value="1">
        </td>
    </tr>
{% } %}
</script>

*@



@*<div id="connectionContainer">
    <div id="connectionContent">*@


<div class="headline">
    <h3>Carga de Archivos</h3>
</div>
<div class="row-fluid">
    <div class="span12">

        <div style="display: table; width: 670px; margin-top: 10px;">
            <div style="display: table-cell; padding-left: 20px; width: 275px; vertical-align: top;">
                <form id="fileupload" method="POST" enctype="multipart/form-data">
                    <div><b>Paso a Seguir:</b></div>
                    <br />
                    <ol>
                        <li>
                            @*<span class="btn btn-success fileinput-button">
                                <i class="icon-plus icon-white"></i>
                                <input type="file" name="files[]" id="filecontrol" multiple>
                            </span>*@

                            <span class="btn btn-success fileinput-button" style="margin-top: 5px;">
                                <i class="icon-plus icon-white"></i>
                                <span>Subir imagenes...</span>
                                <input type="file" name="files[]" id="filecontrol" multiple>
                            </span>
                        </li>
                        <br />
                        <li>
                            <button type="submit" class="btn-u btn-primary start">
                                <i class="icon-upload icon-white"></i>
                                <span>Start upload</span>
                            </button>
                        </li>
                    </ol>
                </form>
            </div>
            @*   <div style="display: table-cell; width: 100px; text-align: center; vertical-align: middle;">- OR -</div>
            <div style="display: table-cell; width: 275px;">
                <div id="dropzone" style='border: 3px dashed #ccc; width: 150px; height: 80px; margin: 0px auto; text-align: center; display: block'>
                    <p style="padding: 10px 10px; text-align: center">Drag & drop files here</p>
                </div>
            </div>*@
        </div>

        <div id="imagesResult">
            <table id="imagesColumns" class="table" style="width: 655px">
                <thead>
                    @*  <tr>
                        <th style="text-align: center; width: 120px;">Preview</th>
                        <th style="text-align: center; width: 435px;">Resource name</th>
                        <th></th>
                    </tr>*@
                </thead>
                <tbody>

                    @*   @foreach (var record in @Model)
                {
                    <tr>
                        <td style="padding: 5px 0px;">
                            <img class="imgPreview" src="@Url.Content(record.Url)" width="50" height="50"/>
                        </td>
                        <td>
                            <div>@record.Name</div>
                            <div class="font-gray" style="font-size: 8pt;">@record.ContentType</div>
                        </td>
                        <td><a data-name="@record.Name" data-url="@record.VirtualPathFile" onclick="DeleteFile(this)"><span class="ui-button-icon-primary ui-icon-dialog ui-icon-delete"></span></a></td>
                    </tr>
                }

                @if (@Model.Count() == 0) {
                    <tr id="imagesColumns_tr_empty">
                        <td colspan="3" style="text-align: center;">No resources</td>
                    </tr>
                }*@
                </tbody>
            </table>
        </div>

    </div>
</div>
@*    </div>
</div>*@

<script>
    var url_handler = '@Url.Content("~/HttpHandler/UploadHandler.ashx")';
    var dropbox = $('#dropzone')
    dropbox.filedrop({
        // The name of the $_FILES entry:
        paramname: 'pic',
        maxfiles: 4,
        maxfilesize: 20,
        url: url_handler,
        uploadFinished: function (i, file, response, size, targetdiv) {
            debugger;
            $('#imagesColumns_tr_empty').remove();
            LoadNewFilesDrop(response, file.name);
            hideProgress();
        },
        error: function (err, file) {
            switch (err) {
                case 'BrowserNotSupported':
                    showMessage('Your browser does not support HTML5 file uploads!');
                    break;
                case 'TooManyFiles':
                    alert('Too many files! Please select 5 at most!');
                    break;
                case 'FileTooLarge':
                    alert(file.name + ' is too large! Please upload files up to 5mb.');
                    break;
                default:
                    break;
            }
            hideProgress();
        },
        // Called before each upload is started
        beforeEach: function (file) {
            var ext = file.name.split('.').pop().toLowerCase()
            var typeArr = ['jpg', 'jpeg', 'gif', 'png', 'pdf', 'doc', 'docx', 'ppt', 'pptx', 'mp3', 'mp4', 'mpeg', 'kml'];
            if (jQuery.inArray(ext, typeArr) == -1) {
                jAlert('Invalid file type. Please, choose a valid type (ex. "jpg", "jpeg", "gif", "png", "pdf", "doc", "docx", "ppt", "pptx")');
                return false;
            }
        },
        uploadStarted: function (i, file, len) {
            // createImage(file);
            showProgress('@Url.Content("~/images/loading.gif")');
        },
    });

        $(document).ready(function () {

            $('#fileupload').submit(function (e) {
                debugger;
                var lenght = jQuery(".thumbnails").find('li[itemid]').length;
                if (lenght == undefined)
                    lenght = 0;
                else if (lenght == 0)
                    lenght = -1;

                e.preventDefault();
                if (VerifyFiles()) {
                    return false;
                }
                UploadFiles(lenght);
                return false;
            });
        });

        function VerifyFiles() {
            if ($('#filecontrol').val() == '') {
                jAlert('No file(s) selected. Please, choose a valid file to upload.');
                return true;
            }
            if ($('#filecontrol').val() != '') {
                var ext = $('#filecontrol').val().split('.').pop().toLowerCase();
                var typeArr = ['jpg', 'jpeg', 'gif', 'png', 'pdf', 'doc', 'docx', 'ppt', 'pptx'];
                if (jQuery.inArray(ext, typeArr) == -1) {
                    jAlert('Invalid file type. Please, choose a valid type (ex. "jpg", "jpeg", "gif", "png", "pdf", "doc", "docx", "ppt", "pptx")');
                    return true;
                }
            }
            return false;
        }

        function UploadFiles(lenght) {
            
            var formData = new FormData();
            if (lenght == 0) {
                $.each($('#filecontrol')[0].files, function (i, file) {
                    formData.append('uploadFile-' + i, file);
                });
            }
            else {
                if (lenght == -1) lenght = 0;
                var counter = 4 - parseInt(lenght);
                $.each($('#filecontrol')[0].files, function (i, file) {
                    if (counter == i)
                        return false;
                    formData.append('uploadFile-' + i, file);
                });
            }
           
            formData.append('action', url_handler);
            showProgress('@Url.Content("~/images/loading.gif")');
            jQuery.ajax({
                url: url_handler,
                type: 'POST',
                cache: false,
                contentType: false,
                processData: false,

                //MODIFIED - From ajaxData to formData
                data: formData,

                success: function (data, textStatus, jqXHR) {

                    $('#filecontrol').val('');
                    $('#imagesColumns_tr_empty').remove();

                    LoadNewFiles(data);

                    hideProgress();
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    hideProgress();
                    jAlert('An exception has ocurred when uploading the file: ' + jqXHR.responseText, 'Error');
                }
            });
        }

        function LoadNewFiles(data, fileName) {
            var result = JSON.parse(data);
            $.each(result.$values, function (i, e) {
                debugger;
                var addNewFile = (fileName == undefined) ? true : (fileName.toLowerCase() == e.name.toLowerCase());
                if (addNewFile) {
                    var row = $('<tr/>');
                    row.append($('<td style="padding: 5px 0px;"><img class="imgPreview" src="' + e.thumbnail_url + '" width="50" height="50"/></td>'));
                    row.append($('<td><div>' + e.name + '</div><div class="font-gray" style="font-size: 8pt;">' + e.type + '</div></td>'));


                    var deleteElement = '<td><button data-name="' + e.name + '" class="btn btn-danger" data-url="' + e.url + '" onclick="DeleteFile(this)" value="Delete"> <i class="icon-trash icon-white"></i></button></td>';
                    row.append($(deleteElement));

                    $('#imagesColumns').find('tbody').append(row);
                }
            });
        }


        function LoadNewFilesDrop(data, fileName) {
            $.each(data.$values, function (i, e) {
                debugger;
                var addNewFile = (fileName == undefined) ? true : (fileName.toLowerCase() == e.name.toLowerCase());
                if (addNewFile) {
                    var row = $('<tr/>');
                    row.append($('<td style="padding: 5px 0px;"><img class="imgPreview" src="' + e.thumbnail_url + '" width="50" height="50"/></td>'));
                    row.append($('<td><div>' + e.name + '</div><div class="font-gray" style="font-size: 8pt;">' + e.type + '</div></td>'));


                    var deleteElement = '<td><button data-name="' + e.name + '" class="btn btn-danger" data-url="' + e.url + '" onclick="DeleteFile(this)" value="Delete"> <i class="icon-trash icon-white"></i></button></td>';
                    row.append($(deleteElement));

                    $('#imagesColumns').find('tbody').append(row);
                }
            });
        }

        function DeleteFile(link) {
            var url = $(link).attr('data-url');
            debugger;
            var urldelete = '@Url.Content("~/HttpHandler/UploadHandler.ashx")' + url;

            jConfirm('Do you want to delete "' + name + '" resource?', 'Delete resource', function (confirm) {
                if (confirm) {
                    showProgress('@Url.Content("~/images/loading.gif")');
                jQuery.ajax({
                    url: urldelete,
                    type: 'POST',
                    dataType: "json",
                    cache: false,
                    success: function (data, textStatus, jqXHR) {
                        $(link).parents('tr').first().remove();
                        var rowCount = $('#imagesColumns >tbody >tr').length
                        if (rowCount == 0) {
                            var row = $('<tr id="imagesColumns_tr_empty">' +
                                '<td colspan="3" style="text-align: center;">No resources</td>' +
                            '</tr>');
                            $('#imagesColumns').find('tbody').append(row);
                        }

                        hideProgress();
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        hideProgress();
                        jAlert('An exception has ocurred when uploading the file: ' + jqXHR.responseText, 'Error');
                    }
                });
            }
        });
    }

    (function ($) {
        $.fn.imageResize = function (options) {
            var that = this;
            var settings = {
                width: 50,
                height: 50
            };
            options = $.extend(settings, options);

            if (!that.is('img')) {
                return;
            }

            return that.each(function () {
                var maxWidth = options.width;
                var maxHeight = options.height;
                var ratio = 0;
                var width = $(that).width();
                var height = $(that).height();

                if (width > maxWidth) {
                    ratio = maxWidth / width;
                    $(that).css('width', maxWidth);
                    $(that).css('height', height * ratio);

                }

                if (height > maxHeight) {
                    ratio = maxHeight / height;
                    $(that).css('height', maxHeight);
                    $(that).css('width', width * ratio);

                }
            });
        };
    })(jQuery);

    function showProgress(loadingImgSrc) {
        $ki.blockUI({
            message: '<p>Por favor espere mientra se procesa la solicitud...</p><img src="' + loadingImgSrc + '" /> <br>',
            css: {
                width: '450px',
                border: 'none',
                padding: '15px',
                backgroundColor: '#fafafa',
                'border-radius': '10px',
                opacity: .95,
                color: '#000',
                'font-size': '18px',
                'box-shadow': '0px 0px 12px rgba(0,0,0,.6)'
            }
        });
    }

    function hideProgress() {
        $ki.unblockUI();
    }
</script>
